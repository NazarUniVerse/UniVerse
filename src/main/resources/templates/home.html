<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ana Sayfa - UniVerse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .story-avatar { width: 65px; height: 65px; object-fit: cover; border-radius: 50%; border: 3px solid #ec4899; padding: 2px; transition: 0.2s; }
        .story-avatar:hover { transform: scale(1.1); }
        .story-item { cursor: pointer; text-align: center; margin-right: 15px; }
        .story-name { font-size: 0.75rem; margin-top: 5px; color: var(--text-color); max-width: 70px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .anonymous-card { background-color: #2d3436 !important; color: #dfe6e9 !important; border: 1px solid #636e72; }
        .anonymous-card .text-muted { color: #b2bec3 !important; }
        .anonymous-card h6 { color: #fff !important; }
    </style>
</head>
<body style="padding-top: 80px;">

    <nav class="navbar navbar-expand-lg navbar-modern fixed-top">
        <div class="container">
            <a class="navbar-brand brand-logo" href="/home"><i class="fas fa-graduation-cap"></i> UniVerse</a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item"><a class="nav-link active fw-bold" href="/home">Akış</a></li>
                    <li class="nav-item mx-2"><a class="nav-link position-relative" href="/chat" title="Mesajlar"><i class="fas fa-comment-dots fa-lg"></i></a></li>
                    <li class="nav-item mx-2"><a class="nav-link position-relative" href="/notifications"><i class="fas fa-bell fa-lg"></i><span th:if="${unreadCount > 0}" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light" style="font-size: 0.6rem;"><span th:text="${unreadCount}">0</span></span></a></li>
                    <li class="nav-item dropdown ms-3">
                        <a class="nav-link dropdown-toggle p-0" href="#" data-bs-toggle="dropdown"><img th:src="${user.avatarPath}" class="rounded-circle border border-2 shadow-sm" width="45" height="45" style="object-fit: cover; border-color: var(--primary-color) !important;"></a>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-3 p-2">
                            <li><h6 class="dropdown-header fw-bold text-primary" th:text="${username}">Kullanıcı</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li th:if="${user.email == 'admin@universe.edu.tr'}"><a class="dropdown-item rounded text-danger fw-bold bg-light mb-2" href="/admin/messages"><i class="fas fa-user-shield me-2"></i> Yönetici Paneli</a></li>
                            <li><a class="dropdown-item rounded" href="/profile"><i class="fas fa-user me-2 text-muted"></i> Profilim</a></li>
                            <li><a class="dropdown-item rounded" href="/saved-posts"><i class="fas fa-bookmark me-2 text-muted"></i> Kaydedilenler</a></li>
                            <li><a class="dropdown-item rounded" href="/settings"><i class="fas fa-cog me-2 text-muted"></i> Ayarlar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item rounded text-danger fw-bold" href="/logout"><i class="fas fa-sign-out-alt me-2"></i> Çıkış Yap</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-3 d-none d-lg-block">
                <div class="card glass-card mb-4 border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block"><img th:src="${user.avatarPath}" class="rounded-circle border border-3 mb-2" width="80" height="80" style="object-fit: cover; border-color: var(--primary-color) !important;"><span th:if="${user.isVip()}" class="position-absolute top-0 end-0 p-1 bg-warning border border-light rounded-circle"></span></div>
                            <h5 class="fw-bold mb-0" th:text="${username}">Kullanıcı</h5><small class="text-muted" th:text="${user.department}">Bölüm</small>
                        </div>
                        <hr>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a href="/home" class="text-decoration-none d-block p-2 rounded hover-bg" th:classappend="${activeCategory == null} ? 'bg-light fw-bold text-primary' : 'text-dark'"><i class="fas fa-globe me-2"></i> Genel Akış</a></li>
                            <li class="mb-2"><a href="/home?category=Kampus" class="text-decoration-none d-block p-2 rounded hover-bg text-dark"><i class="fas fa-university me-2 text-warning"></i> Kampüs</a></li>
                            <li class="mb-2"><a href="/notes" class="text-decoration-none d-block p-2 rounded hover-bg text-dark"><i class="fas fa-book me-2 text-success"></i> Not Havuzu</a></li>
                            <li class="mb-2"><a href="/events" class="text-decoration-none d-block p-2 rounded hover-bg text-dark"><i class="fas fa-calendar-alt me-2 text-primary"></i> Etkinlikler</a></li>
                            <li class="mb-2"><a href="/market" class="text-decoration-none d-block p-2 rounded hover-bg text-dark"><i class="fas fa-store me-2 text-success"></i> Uni-Pazar</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="glass-card mb-4 p-3 d-flex align-items-center overflow-auto custom-scrollbar" style="white-space: nowrap;">
                    <div class="story-item" data-bs-toggle="modal" data-bs-target="#uploadStoryModal"><div class="story-avatar d-flex align-items-center justify-content-center bg-light border-0"><i class="fas fa-plus fa-lg text-primary"></i></div><div class="small fw-bold mt-1">Hikaye Ekle</div></div>
                    <div th:each="story : ${stories}" class="story-item" data-bs-toggle="modal" th:data-bs-target="'#viewStoryModal' + ${story.id}" th:onclick="'markStoryViewed(' + ${story.id} + ')'">
                        <img th:src="${story.user.avatarPath}" class="story-avatar" th:style="${!story.viewers.contains(user)} ? 'border-color: #ec4899' : 'border-color: #ccc'"><div class="small mt-1" th:text="${#strings.abbreviate(story.user.fullname, 10)}"></div>
                    </div>
                </div>

                <div class="card glass-card mb-4 border-0 shadow-sm"><div class="card-body"><form action="/post" method="post" enctype="multipart/form-data"><div class="d-flex mb-3"><img th:src="${user.avatarPath}" class="rounded-circle me-3 border" width="50" height="50"><textarea name="content" class="form-control border-0 bg-light" rows="2" placeholder="Neler oluyor?"></textarea></div><div class="d-flex justify-content-between align-items-center"><div><label class="btn btn-light btn-sm rounded-pill text-primary me-2 border"><i class="fas fa-image"></i><input type="file" name="image" class="d-none"></label><select name="category" class="form-select form-select-sm d-inline-block w-auto rounded-pill border bg-light"><option value="Genel">Genel</option><option value="Itiraf">İtiraf</option></select><div class="form-check form-switch d-inline-block ms-2"><input class="form-check-input" type="checkbox" name="isAnonymous" id="anon"><label class="small text-muted" for="anon"> Gizli</label></div></div><button type="submit" class="btn btn-primary-modern rounded-pill px-4">Paylaş</button></div></form></div></div>

                <div th:each="post : ${posts}" class="card glass-card mb-4 border-0 shadow-sm" th:classappend="${post.isAnonymous()} ? 'anonymous-card' : ''">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <a th:if="${!post.isAnonymous()}" th:href="@{'/user/' + ${post.authorId}}" class="text-decoration-none text-dark d-flex align-items-center"><img th:src="${post.authorAvatar}" class="rounded-circle me-2 border" width="45" height="45"><div><h6 class="fw-bold mb-0" th:text="${post.authorName}"></h6><small class="text-muted" th:text="${post.timeAgo}"></small></div></a>
                                <div th:if="${post.isAnonymous()}" class="d-flex align-items-center"><div class="rounded-circle me-2 border bg-dark d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;"><i class="fas fa-user-secret text-white"></i></div><div><h6 class="fw-bold mb-0 text-white">Gizli İtirafçı</h6><small class="text-muted" th:text="${post.timeAgo}"></small></div></div>
                            </div>
                            <a th:href="@{'/post/save/' + ${post.id}}" class="btn btn-link text-muted p-0"><i th:class="${user.savedPosts.contains(post)} ? 'fas fa-bookmark text-primary' : 'far fa-bookmark'"></i></a>
                        </div>
                        <p class="card-text fs-5" th:text="${post.content}"></p>
                        <div th:if="${post.imageUrl != null}" class="mb-3"><img th:src="@{'/uploads/' + ${post.id} + '/' + ${post.imageUrl}}" class="img-fluid rounded-3 w-100"></div>
                        <div class="d-flex justify-content-between border-top pt-3"><a th:href="@{'/post/like/' + ${post.id}}" class="btn btn-light rounded-pill btn-sm px-3" th:classappend="${post.likedByCurrentUser} ? 'text-danger fw-bold' : ''"><i class="fas fa-heart"></i> <span th:text="${post.getLikeCount()}"></span></a><button class="btn btn-light rounded-pill btn-sm px-3 text-muted" data-bs-toggle="collapse" th:data-bs-target="'#c'+${post.id}"><i class="far fa-comment"></i> <span th:text="${post.comments.size()}"></span></button></div>
                        <div class="collapse mt-3" th:id="'c'+${post.id}">
                            <div class="bg-light p-3 rounded-3 border">
                                <div th:each="comment : ${post.comments}" class="mb-2 border-bottom pb-2">
                                    <strong class="text-dark" th:text="${comment.authorName}">Biri</strong>: 
                                    <span class="text-muted" th:text="${comment.content}">Yorum...</span>
                                </div>
                                <form action="/post/comment" method="post" class="mt-2 d-flex">
                                    <input type="hidden" name="postId" th:value="${post.id}">
                                    <input type="text" name="content" class="form-control rounded-pill me-2" placeholder="Yorum yap..." required>
                                    <button type="submit" class="btn btn-sm btn-primary rounded-circle"><i class="fas fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 d-none d-lg-block"><div class="card glass-card border-0 shadow-sm"><div class="card-body"><h6 class="fw-bold text-muted mb-3">Trendler</h6><div class="d-flex flex-wrap"><span class="badge bg-light text-dark border p-2 m-1">#VizeHaftası</span><span class="badge bg-light text-dark border p-2 m-1">#İstinyeFest</span></div></div></div></div>
        </div>
    </div>

    <div th:each="story : ${stories}" class="modal fade" th:id="'viewStoryModal' + ${story.id}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-transparent border-0"><div class="modal-body p-0 text-center position-relative"><button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button><img th:src="@{${story.getImagePath()}}" class="img-fluid rounded-4 shadow-lg" style="max-height: 80vh;"><div class="position-absolute bottom-0 start-0 p-3 text-white text-start w-100 d-flex justify-content-between align-items-end" style="background: linear-gradient(transparent, rgba(0,0,0,0.8)); border-radius: 0 0 1rem 1rem;"><div class="d-flex align-items-center"><img th:src="${story.user.avatarPath}" class="rounded-circle border border-2 me-2" width="40" height="40"><h6 class="mb-0 fw-bold" th:text="${story.user.fullname}"></h6></div><div class="d-flex align-items-center"><div th:if="${story.user.id == user.id}" class="me-2 text-end small"><div class="badge bg-dark bg-opacity-50 mb-1 d-block"><i class="fas fa-eye me-1"></i> <span th:text="${story.viewers.size()}"></span></div><div class="badge bg-danger bg-opacity-75"><i class="fas fa-heart me-1"></i> <span th:text="${story.likes.size()}"></span></div></div><div th:unless="${story.user.id == user.id}"><a th:href="@{'/story/like/' + ${story.id}}" class="btn rounded-circle btn-light" th:classappend="${story.likes.contains(user)} ? 'text-danger' : 'text-muted'"><i class="fas fa-heart"></i></a></div></div></div></div></div></div>
    </div>
    <div class="modal fade" id="uploadStoryModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0"><div class="modal-header bg-light border-0"><h5 class="modal-title fw-bold text-primary">Hikaye Ekle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="/story/upload" method="post" enctype="multipart/form-data"><div class="modal-body p-4"><input type="file" name="image" class="form-control" accept="image/*" required><p class="small text-muted mt-2">24 saat sonra silinir.</p></div><div class="modal-footer border-0"><button type="submit" class="btn btn-primary-modern rounded-pill w-100">Paylaş</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        (function(){let s=localStorage.getItem('theme')||'light';const v=[[${user.isVip}]];if(s==='gold'&&!v){s='light';localStorage.setItem('theme','light')}document.documentElement.setAttribute('data-theme',s)})();
        function markStoryViewed(id){fetch('/story/view/'+id)}
    </script>
</body>
</html>